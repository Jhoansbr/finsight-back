// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                Int       @id @default(autoincrement()) @map("id_usuario")
  email             String    @unique @db.VarChar(255)
  passwordHash      String    @map("password_hash") @db.VarChar(255)
  nombre            String    @db.VarChar(100)
  apodo             String?   @db.VarChar(100)
  fotoPerfil        String?   @map("foto_perfil") @db.Text
  telegram          String?   @db.VarChar(100)
  whatsapp          String?   @db.VarChar(20)
  fechaRegistro     DateTime  @default(now()) @map("fecha_registro") @db.Timestamp(6)
  fechaUltimaSesion DateTime? @map("fecha_ultima_sesion") @db.Timestamp(6)
  activo            Boolean   @default(true)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  ingresos              Ingreso[]
  gastos                Gasto[]
  metasAhorros          MetaAhorro[]
  ahorros               Ahorro[]
  presupuestos          Presupuesto[]
  preferencia           PreferenciaUsuario?
  estadisticas          Estadistica[]
  recordatorios         Recordatorio[]
  predicciones          Prediccion[]
  reportes              Reporte[]
  plantillasReportes    PlantillaReporte[]

  @@map("usuarios")
}

model Categoria {
  id          Int      @id @default(autoincrement()) @map("id_categoria")
  nombre      String   @unique @db.VarChar(100)
  descripcion String?  @db.Text
  icono       String?  @db.VarChar(50)
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  ingresos              Ingreso[]
  gastos                Gasto[]
  presupuestoCategorias PresupuestoCategoria[]

  @@map("categorias")
}

model TipoPago {
  id          Int      @id @default(autoincrement()) @map("id_tipo_pago")
  nombre      String   @unique @db.VarChar(50)
  descripcion String?  @db.Text
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  ingresos Ingreso[]
  gastos   Gasto[]
  ahorros  Ahorro[]

  @@map("tipos_pago")
}

model Frecuencia {
  id             Int      @id @default(autoincrement()) @map("id_frecuencia")
  nombre         String   @unique @db.VarChar(50)
  descripcion    String?  @db.Text
  diasIntervalo  Int?     @map("dias_intervalo")
  activo         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  ingresos Ingreso[]
  gastos   Gasto[]

  @@map("frecuencias")
}

model Ingreso {
  id                    Int         @id @default(autoincrement()) @map("id_ingreso")
  usuarioId             Int         @map("id_usuario")
  categoriaId           Int?        @map("id_categoria")
  tipoPagoId            Int?        @map("id_tipo_pago")
  frecuenciaId          Int?        @map("id_frecuencia")
  metaAhorroAsociadoId  Int?        @map("id_meta_ahorro_asociado")
  nombre                String      @db.VarChar(200)
  monto                 Decimal     @db.Decimal(15, 2)
  fecha                 DateTime    @db.Date
  descripcion           String?     @db.Text
  esRecurrente          Boolean     @default(false) @map("es_recurrente")
  activo                Boolean     @default(true)
  createdAt             DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario            Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  categoria          Categoria?  @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
  tipoPago           TipoPago?   @relation(fields: [tipoPagoId], references: [id], onDelete: SetNull)
  frecuencia         Frecuencia? @relation(fields: [frecuenciaId], references: [id], onDelete: SetNull)
  metaAhorroAsociado MetaAhorro? @relation(fields: [metaAhorroAsociadoId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([categoriaId])
  @@index([fecha])
  @@map("ingresos")
}

model Gasto {
  id                    Int         @id @default(autoincrement()) @map("id_gasto")
  usuarioId             Int         @map("id_usuario")
  categoriaId           Int?        @map("id_categoria")
  tipoPagoId            Int?        @map("id_tipo_pago")
  frecuenciaId          Int?        @map("id_frecuencia")
  metaAhorroAsociadoId  Int?        @map("id_meta_ahorro_asociado")
  nombre                String      @db.VarChar(200)
  monto                 Decimal     @db.Decimal(15, 2)
  fecha                 DateTime    @db.Date
  descripcion           String?     @db.Text
  esRecurrente          Boolean     @default(false) @map("es_recurrente")
  activo                Boolean     @default(true)
  createdAt             DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario            Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  categoria          Categoria?  @relation(fields: [categoriaId], references: [id], onDelete: SetNull)
  tipoPago           TipoPago?   @relation(fields: [tipoPagoId], references: [id], onDelete: SetNull)
  frecuencia         Frecuencia? @relation(fields: [frecuenciaId], references: [id], onDelete: SetNull)
  metaAhorroAsociado MetaAhorro? @relation(fields: [metaAhorroAsociadoId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([categoriaId])
  @@index([fecha])
  @@map("gastos")
}

model MetaAhorro {
  id             Int       @id @default(autoincrement()) @map("id_meta_ahorro")
  usuarioId      Int       @map("id_usuario")
  nombre         String    @db.VarChar(200)
  descripcion    String?   @db.Text
  montoObjetivo  Decimal?  @map("monto_objetivo") @db.Decimal(15, 2)
  montoActual    Decimal   @default(0) @map("monto_actual") @db.Decimal(15, 2)
  fechaInicio    DateTime? @map("fecha_inicio") @db.Date
  fechaObjetivo  DateTime? @map("fecha_objetivo") @db.Date
  activo         Boolean   @default(true)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario             Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  ahorros             Ahorro[]
  ingresosAsociados   Ingreso[]
  gastosAsociados     Gasto[]

  @@index([usuarioId])
  @@map("metas_ahorros")
}

model Ahorro {
  id              Int      @id @default(autoincrement()) @map("id_ahorro")
  metaAhorroId    Int      @map("id_meta_ahorro")
  usuarioId       Int      @map("id_usuario")
  tipoPagoId      Int?     @map("id_tipo_pago")
  nombre          String   @db.VarChar(200)
  monto           Decimal  @db.Decimal(15, 2)
  fecha           DateTime @db.Date
  tipoMovimiento  String   @map("tipo_movimiento") @db.VarChar(20)
  descripcion     String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)

  metaAhorro MetaAhorro @relation(fields: [metaAhorroId], references: [id], onDelete: Cascade)
  usuario    Usuario    @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  tipoPago   TipoPago?  @relation(fields: [tipoPagoId], references: [id], onDelete: SetNull)

  @@index([usuarioId])
  @@index([metaAhorroId])
  @@index([fecha])
  @@map("ahorros")
}

model PreferenciaUsuario {
  id                  Int      @id @default(autoincrement()) @map("id_preferencia")
  usuarioId           Int      @unique @map("id_usuario")
  moneda              String   @default("COP") @db.VarChar(10)
  pais                String?  @db.VarChar(100)
  zonaHoraria         String   @default("America/Bogota") @map("zona_horaria") @db.VarChar(50)
  idioma              String   @default("es") @db.VarChar(10)
  notificacionesEmail Boolean  @default(true) @map("notificaciones_email")
  notificacionesPush  Boolean  @default(true) @map("notificaciones_push")
  createdAt           DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("preferencias_usuario")
}

model Presupuesto {
  id         Int      @id @default(autoincrement()) @map("id_presupuesto")
  usuarioId  Int      @map("id_usuario")
  anio       Int
  mes        Int
  montoTotal Decimal  @default(0) @map("monto_total") @db.Decimal(15, 2)
  activo     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt  DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario    Usuario                @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  categorias PresupuestoCategoria[]

  @@unique([usuarioId, anio, mes])
  @@index([usuarioId])
  @@map("presupuestos")
}

model PresupuestoCategoria {
  id              Int      @id @default(autoincrement()) @map("id_presupuesto_categoria")
  presupuestoId   Int      @map("id_presupuesto")
  categoriaId     Int      @map("id_categoria")
  montoAsignado   Decimal  @map("monto_asignado") @db.Decimal(15, 2)
  montoGastado    Decimal  @default(0) @map("monto_gastado") @db.Decimal(15, 2)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  presupuesto Presupuesto @relation(fields: [presupuestoId], references: [id], onDelete: Cascade)
  categoria   Categoria   @relation(fields: [categoriaId], references: [id], onDelete: Cascade)

  @@unique([presupuestoId, categoriaId])
  @@index([presupuestoId])
  @@index([categoriaId])
  @@map("presupuesto_categorias")
}

model Estadistica {
  id               Int       @id @default(autoincrement()) @map("id_estadistica")
  usuarioId        Int       @map("id_usuario")
  tipoEstadistica  String    @map("tipo_estadistica") @db.VarChar(50)
  periodoInicio    DateTime? @map("periodo_inicio") @db.Date
  periodoFin       DateTime? @map("periodo_fin") @db.Date
  datos            Json?     @db.JsonB
  fechaCalculo     DateTime  @default(now()) @map("fecha_calculo") @db.Timestamp(6)
  activo           Boolean   @default(true)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([tipoEstadistica])
  @@map("estadisticas")
}

model Recordatorio {
  id                    Int       @id @default(autoincrement()) @map("id_recordatorio")
  usuarioId             Int       @map("id_usuario")
  ingresoId             Int?      @map("id_ingreso")
  gastoId               Int?      @map("id_gasto")
  metaAhorroId          Int?      @map("id_meta_ahorro")
  tipoRecordatorio      String    @map("tipo_recordatorio") @db.VarChar(50)
  titulo                String    @db.VarChar(200)
  descripcion           String?   @db.Text
  fechaRecordatorio     DateTime  @map("fecha_recordatorio") @db.Timestamp(6)
  fechaVencimiento      DateTime? @map("fecha_vencimiento") @db.Date
  frecuenciaRepeticion  String?   @map("frecuencia_repeticion") @db.VarChar(50)
  estado                String    @default("pendiente") @db.VarChar(20)
  metodoNotificacion    String    @default("push") @map("metodo_notificacion") @db.VarChar(50)
  notificado            Boolean   @default(false)
  activo                Boolean   @default(true)
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt             DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([fechaRecordatorio])
  @@index([estado])
  @@map("recordatorios")
}

model Prediccion {
  id                      Int       @id @default(autoincrement()) @map("id_prediccion")
  usuarioId               Int       @map("id_usuario")
  tipoPrediccion          String    @map("tipo_prediccion") @db.VarChar(50)
  modeloUsado             String?   @map("modelo_usado") @db.VarChar(100)
  periodoPrediccionInicio DateTime  @map("periodo_prediccion_inicio") @db.Date
  periodoPrediccionFin    DateTime  @map("periodo_prediccion_fin") @db.Date
  valorPredicho           Decimal?  @map("valor_predicho") @db.Decimal(15, 2)
  valorReal               Decimal?  @map("valor_real") @db.Decimal(15, 2)
  confianza               Decimal?  @db.Decimal(5, 2)
  factoresConsiderados    Json?     @map("factores_considerados") @db.JsonB
  fechaPrediccion         DateTime  @default(now()) @map("fecha_prediccion") @db.Timestamp(6)
  fechaConfirmacion       DateTime? @map("fecha_confirmacion") @db.Timestamp(6)
  precisionAjuste         Decimal?  @map("precision_ajuste") @db.Decimal(5, 2)
  activo                  Boolean   @default(true)
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt               DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([tipoPrediccion])
  @@map("predicciones")
}

model MetricaModelo {
  id                      Int       @id @default(autoincrement()) @map("id_metrica")
  modelo                  String    @db.VarChar(100)
  tipoPrediccion          String    @map("tipo_prediccion") @db.VarChar(50)
  precisionPromedio       Decimal?  @map("precision_promedio") @db.Decimal(5, 2)
  datosEntrenamiento      Json?     @map("datos_entrenamiento") @db.JsonB
  fechaEntrenamiento      DateTime? @map("fecha_entrenamiento") @db.Timestamp(6)
  fechaUltimaEvaluacion   DateTime? @map("fecha_ultima_evaluacion") @db.Timestamp(6)
  activo                  Boolean   @default(true)
  createdAt               DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  @@map("metricas_modelos")
}

model Reporte {
  id                     Int       @id @default(autoincrement()) @map("id_reporte")
  usuarioId              Int       @map("id_usuario")
  tipoReporte            String    @map("tipo_reporte") @db.VarChar(50)
  nombreReporte          String    @map("nombre_reporte") @db.VarChar(200)
  descripcion            String?   @db.Text
  parametros             Json?     @db.JsonB
  periodoInicio          DateTime? @map("periodo_inicio") @db.Date
  periodoFin             DateTime? @map("periodo_fin") @db.Date
  formato                String    @default("pdf") @db.VarChar(20)
  rutaArchivo            String?   @map("ruta_archivo") @db.Text
  urlArchivo             String?   @map("url_archivo") @db.Text
  tamanoBytes            BigInt?   @map("tamano_bytes")
  fechaGeneracion        DateTime  @default(now()) @map("fecha_generacion") @db.Timestamp(6)
  fechaProgramada        DateTime? @map("fecha_programada") @db.Timestamp(6)
  estado                 String    @default("completado") @db.VarChar(20)
  programado             Boolean   @default(false)
  frecuenciaProgramacion String?   @map("frecuencia_programacion") @db.VarChar(50)
  activo                 Boolean   @default(true)
  createdAt              DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt              DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([tipoReporte])
  @@index([fechaGeneracion])
  @@map("reportes")
}

model PlantillaReporte {
  id              Int      @id @default(autoincrement()) @map("id_plantilla")
  usuarioId       Int?     @map("id_usuario")
  nombrePlantilla String   @map("nombre_plantilla") @db.VarChar(200)
  tipoReporte     String   @map("tipo_reporte") @db.VarChar(50)
  configuracion   Json     @db.JsonB
  activo          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamp(6)

  usuario Usuario? @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@map("plantillas_reportes")
}
